<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>GENERADOR — Etiquetas (PDF) | MarckBusiness</title>

  <!-- Librerías -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b2f;
      --card:#0b1628;
      --text:#eaf1ff;
      --muted:#9fb0c8;
      --accent:#2b7cff;
      --accent2:#1dd3b0;
      --ok:#22c55e;
      --danger:#ef4444;
      --border:rgba(255,255,255,.10);
      --shadow:0 16px 50px rgba(0,0,0,.55);
      --radius:18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", "Noto Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(900px 650px at 10% 0%, rgba(43,124,255,.18), transparent 55%),
        radial-gradient(900px 650px at 90% 0%, rgba(29,211,176,.14), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.03), transparent 40%),
        var(--bg);
      min-height:100vh;
    }

    /* ---------- Layout ---------- */
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .top{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;gap:12px;align-items:center;min-width:260px}
    .brand h1{margin:0;font-size:18px;font-weight:1000;letter-spacing:.2px}
    .brand p{margin:2px 0 0;color:var(--muted);font-weight:850;font-size:13px}

    .logoImg{
      width:48px;height:48px;border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 16px 34px rgba(43,124,255,.14);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
    }
    .logoImg img{width:100%;height:100%;object-fit:contain;padding:6px;display:block;}

    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(43,124,255,.35);
      background:rgba(43,124,255,.10);
      font-weight:1000;color:#cfe4ff;
      user-select:none;white-space:nowrap;
    }

    .grid{display:grid;grid-template-columns: 1.05fr .95fr;gap:14px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}

    .card{
      background: rgba(15, 27, 47, .76);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";position:absolute;inset:-2px;
      background:linear-gradient(135deg, rgba(43,124,255,.18), transparent 38%, rgba(29,211,176,.12));
      filter:blur(18px);opacity:.55;pointer-events:none;
    }
    .card > *{position:relative; z-index:1}
    .card h2{margin:0 0 10px;font-size:15px;font-weight:1000}
    .muted{color:var(--muted);font-weight:850;font-size:13px;line-height:1.35}

    .form{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .field{display:flex;flex-direction:column;gap:6px;min-width:0}
    .field.full{grid-column:1/-1}
    label{font-size:12px;color:var(--muted);font-weight:950;letter-spacing:.2px}

    input, select{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(11, 22, 40, .85);
      color:var(--text);
      outline:none;
      font-weight:950;
    }
    input:focus, select:focus{
      border-color: rgba(43,124,255,.55);
      box-shadow: 0 0 0 4px rgba(43,124,255,.14);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row .grow{flex:1;min-width:220px}

    .btn{
      border:none;cursor:pointer;
      padding:11px 14px;border-radius:14px;
      font-weight:1000;color:#fff;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 14px 30px rgba(43,124,255,.20);
      transition: transform .15s ease, filter .15s ease;
    }
    .btn:hover{transform:translateY(-1px);filter:saturate(1.05)}
    .btn:active{transform:translateY(0)}
    .btn.secondary{background:#0b1628;border:1px solid var(--border);box-shadow:none;color:var(--text)}
    .btn.danger{background:linear-gradient(90deg,#ef4444,#b91c1c)}
    .btn.small{padding:9px 12px;border-radius:12px}

    table{width:100%;border-collapse:collapse;margin-top:12px;overflow:hidden;border-radius:14px;border:1px solid var(--border)}
    th,td{padding:10px 10px;border-bottom:1px solid var(--border);text-align:left;font-weight:900;font-size:13px;vertical-align:top}
    th{background:rgba(43,124,255,.12);color:#cfe4ff}
    tr:last-child td{border-bottom:none}
    td small{color:var(--muted);font-weight:900}

    /* -------- Vista previa -------- */
    .previewWrap{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;margin-top:10px}
    .labelPreview{
      background:#fff;color:#111;border-radius:14px;
      padding:10px;border:1px solid rgba(0,0,0,.12);
      width:340px;max-width:100%;
      transform-origin:top left;
    }

    /* Arriba centrado */
    .pvTop{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:2px;
      text-align:center;
      font-weight:1000;
    }
    .pvName{font-size:14px;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .pvPrice{font-size:14px}

    /* Área blanca + borde para lectura */
    .barcodeBox{
      margin-top:8px;
      background:#fff;
      padding:6px;               /* quiet zone */
      border:2px solid #000;     /* contraste */
      border-radius:10px;
    }
    .labelPreview svg{width:100%;height:56px;display:block} /* más chaparro */

    .footer{margin-top:14px;color:rgba(255,255,255,.65);font-weight:900;font-size:12px;text-align:center}
    .footer b{color:#cfe4ff}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(17,24,39,.92);border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;border-radius:14px;color:#fff;font-weight:950;
      box-shadow:0 20px 44px rgba(0,0,0,.45);
      opacity:0;pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:50;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px);}

    /* ---------- Login Overlay ---------- */
    .loginOverlay{
      position:fixed; inset:0;
      background:
        radial-gradient(900px 650px at 10% 0%, rgba(43,124,255,.20), transparent 55%),
        radial-gradient(900px 650px at 90% 0%, rgba(29,211,176,.16), transparent 55%),
        rgba(0,0,0,.55);
      display:flex;align-items:center;justify-content:center;
      padding:18px;z-index:1000;
    }
    .loginBox{
      width:min(560px, 100%);
      background: rgba(15,27,47,.88);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      box-shadow: 0 24px 70px rgba(0,0,0,.60);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .loginBox:before{
      content:""; position:absolute; inset:-2px;
      background:linear-gradient(135deg, rgba(43,124,255,.22), transparent 40%, rgba(29,211,176,.16));
      filter:blur(18px); opacity:.6; pointer-events:none;
    }
    .loginBox > *{ position:relative; z-index:1; }
    .loginHead{
      display:flex; gap:12px; align-items:center;
      padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,.10);
      margin-bottom:12px;
    }
    .loginTitle{display:flex; flex-direction:column; gap:2px}
    .loginTitle b{font-size:16px; font-weight:1000}
    .loginTitle small{color:var(--muted); font-weight:900}
    .loginForm{display:grid; grid-template-columns: 1fr; gap:10px; margin-top:10px;}
    .loginRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .loginRow input{flex:1; min-width:220px}
    .topRightActions{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div class="loginOverlay" id="loginOverlay" style="display:none">
    <div class="loginBox">
      <div class="loginHead">
        <div class="logoImg" style="width:54px;height:54px;border-radius:16px">
          <img id="loginLogo" src="./LOGO1.png" alt="LOGO1" onerror="this.style.display='none'">
        </div>
        <div class="loginTitle">
          <b>Iniciar sesión</b>
          <small>Ingresa el código para usar el generador</small>
        </div>
      </div>

      <div class="loginForm">
        <div class="field full">
          <label>Código</label>
          <input id="loginCode" type="password" inputmode="numeric" placeholder="••••••" autocomplete="off">
          <div class="muted">Código requerido: <b>363534</b></div>
        </div>

        <div class="loginRow">
          <button class="btn" id="btnLogin" type="button">Entrar</button>
          <button class="btn secondary" id="btnLoginClear" type="button">Limpiar</button>
        </div>
      </div>

      <div class="muted" style="margin-top:10px">
        Nota: el login se guarda en este navegador (localStorage).
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="wrap" id="appWrap" style="display:none">
    <div class="top">
      <div class="brand">
        <div class="logoImg" title="LOGO1 (solo en el sitio)">
          <img id="siteLogo" src="./LOGO1.png" alt="LOGO1">
        </div>
        <div>
          <h1>GENERADOR — Etiquetas (PDF)</h1>
          <p>SKU (5 dígitos) • Nombre • Precio • PDF listo para imprimir</p>
        </div>
      </div>

      <div class="topRightActions">
        <div class="pill">MarckBusiness • Offline • PDF</div>
        <button class="btn secondary" id="btnLogout" type="button">Cerrar sesión</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Producto</h2>
        <div class="form">
          <div class="field">
            <label>SKU (5 dígitos)</label>
            <div class="row">
              <input id="pCode" class="grow" inputmode="numeric" maxlength="5" placeholder="Ej: 00001"/>
              <button class="btn small secondary" id="btnNext" type="button">Siguiente</button>
            </div>
          </div>
          <div class="field">
            <label>Precio (Q)</label>
            <input id="pPrice" type="number" min="0" step="0.01" placeholder="Ej: 129.00"/>
          </div>
          <div class="field full">
            <label>Nombre</label>
            <input id="pName" placeholder="Ej: Camisa Oxford"/>
          </div>
          <div class="field full">
            <div class="row">
              <button class="btn" id="btnSave" type="button">Guardar</button>
              <button class="btn secondary" id="btnClearForm" type="button">Limpiar</button>
            </div>
          </div>
        </div>

        <div class="previewWrap">
          <div>
            <div class="muted"><b>Vista previa</b> (el logo NO va en etiquetas)</div>
            <div class="labelPreview" id="previewBox">
              <div class="pvTop">
                <div class="pvName" id="pvName">—</div>
                <div class="pvPrice" id="pvPrice">Q0.00</div>
              </div>

              <div class="barcodeBox">
                <svg id="pvBarcode"></svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Cola (PDF)</h2>
        <div class="row">
          <input id="qSearch" class="grow" placeholder="Buscar por SKU o nombre..."/>
          <button class="btn secondary" id="btnRefresh" type="button">Refrescar</button>
          <button class="btn danger" id="btnWipe" type="button">Borrar todo</button>
        </div>

        <div class="form" style="margin-top:10px">
          <div class="field">
            <label>Producto</label>
            <select id="pick"></select>
          </div>

          <div class="field">
            <label>Cantidad</label>
            <input id="qty" type="number" min="1" value="1"/>
          </div>

          <div class="field">
            <label>Ancho etiqueta (mm)</label>
            <input id="lblW" type="number" min="20" step="0.1" value="50"/>
          </div>

          <div class="field">
            <label>Alto etiqueta (mm)</label>
            <input id="lblH" type="number" min="20" step="0.1" value="25"/>
          </div>

          <div class="field full">
            <label>Orientación</label>
            <select id="lblOri">
              <option value="landscape" selected>Horizontal</option>
              <option value="portrait">Vertical</option>
              <option value="AUTO">Automática (según ancho/alto)</option>
            </select>
            <div class="muted" style="margin-top:6px">
              Para 50×25 usa <b>Horizontal</b>.
            </div>
          </div>

          <div class="field full">
            <div class="row">
              <button class="btn" id="btnAddToQueue" type="button">Agregar</button>
              <button class="btn secondary" id="btnClearQueue" type="button">Limpiar cola</button>
              <button class="btn" id="btnPDF" type="button">Abrir PDF</button>
            </div>
          </div>
        </div>

        <table>
          <thead>
            <tr><th>SKU</th><th>Nombre</th><th>Precio</th><th>Cant.</th><th style="width:140px">Acción</th></tr>
          </thead>
          <tbody id="queueBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h2>Importar / Exportar</h2>
      <div class="row">
        <button class="btn secondary" id="btnExcel" type="button">Importar Excel</button>
        <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display:none"/>
        <button class="btn secondary" id="btnExport" type="button">Exportar JSON</button>
      </div>
      <div class="muted" style="margin-top:8px">
        Excel esperado: columnas <b>SKU</b>, <b>NOMBRE</b>, <b>PRECIO</b> (opcional: <b>STOCK</b>).
      </div>
    </div>

    <div class="footer">
      Hecho por <b>MarckBusiness</b> — © 2025 Todos los derechos reservados.
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ============================================================
   GENERADOR Etiquetas (IndexedDB)
   Etiquetas 50x25mm horizontales
   SOLO: BARCODE + NOMBRE + PRECIO
   BARCODE: más fuerte y más chaparro
   PDF: contenido centrado arriba/abajo
============================================================ */

const LOGIN_CODE = "363534";
const LOGIN_KEY  = "mb_labels_logged_in_v1";

const DB_NAME="generador_etiquetas_marckbusiness_v3";
const DB_VER=1;
let db;

const $=id=>document.getElementById(id);
const state={queue:[]};

function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.classList.add("show");
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.classList.remove("show"),2000);
}

function money(n){return "Q"+(Number(n||0)).toFixed(2);}
function norm(s){return String(s||"").trim().toLowerCase().replace(/\s+/g," ");}

function pad5(n){return String(n).padStart(5,"0");}
function validateCode5(code){return /^\d{5}$/.test(code);}

// ---------- Login ----------
function isLoggedIn(){ return localStorage.getItem(LOGIN_KEY)==="1"; }
function showLogin(){
  $("loginOverlay").style.display="flex";
  $("appWrap").style.display="none";
  setTimeout(()=>{ $("loginCode").focus(); }, 50);
}
function showApp(){
  $("loginOverlay").style.display="none";
  $("appWrap").style.display="block";
}
function doLogin(){
  const v = String($("loginCode").value||"").trim();
  if(v !== LOGIN_CODE){
    alert("Código incorrecto.");
    $("loginCode").focus();
    $("loginCode").select();
    return;
  }
  localStorage.setItem(LOGIN_KEY,"1");
  toast("Sesión iniciada");
  showApp();
}
function doLogout(){
  if(confirm("¿Cerrar sesión?")){
    localStorage.removeItem(LOGIN_KEY);
    toast("Sesión cerrada");
    showLogin();
  }
}

// ---------- IndexedDB ----------
function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,DB_VER);
    req.onupgradeneeded=e=>{
      const d=e.target.result;
      if(!d.objectStoreNames.contains("products")){
        const s=d.createObjectStore("products",{keyPath:"code"});
        s.createIndex("name","nameKey",{unique:false});
      }
      if(!d.objectStoreNames.contains("meta")) d.createObjectStore("meta",{keyPath:"key"});
    };
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}
function tx(store,mode="readonly"){return db.transaction(store,mode).objectStore(store);}
function idbGet(store,key){
  return new Promise((res,rej)=>{
    const r=tx(store).get(key);
    r.onsuccess=()=>res(r.result||null);
    r.onerror=()=>rej(r.error);
  });
}
function idbPut(store,val){
  return new Promise((res,rej)=>{
    const r=tx(store,"readwrite").put(val);
    r.onsuccess=()=>res(true);
    r.onerror=()=>rej(r.error);
  });
}
function idbAll(store){
  return new Promise((res,rej)=>{
    const r=tx(store).getAll();
    r.onsuccess=()=>res(r.result||[]);
    r.onerror=()=>rej(r.error);
  });
}
function idbClear(){
  return Promise.all([
    new Promise((res,rej)=>{
      const r=db.transaction("products","readwrite").objectStore("products").clear();
      r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error);
    }),
    new Promise((res,rej)=>{
      const r=db.transaction("meta","readwrite").objectStore("meta").clear();
      r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error);
    })
  ]);
}

async function nextCode(){
  const meta=await idbGet("meta","next");
  const n=meta?.value?Number(meta.value):1;
  await idbPut("meta",{key:"next",value:n+1});
  return pad5(n);
}

// ---------- BARCODE fuerte + chaparro (SVG preview) ----------
function drawBarcodeToSVG(svgEl, code){
  svgEl.innerHTML="";
  if(!validateCode5(code)) return;

  try{
    JsBarcode(svgEl, code, {
      format: "CODE128",
      displayValue: false,
      margin: 0,
      height: 44,      // chaparro
      width: 3.4,      // fuerte (barras más gruesas)
      background: "#ffffff",
      lineColor: "#000000"
    });
  }catch(e){}
}

// ---------- Preview ----------
function renderPreview(){
  const code=$("pCode").value.trim()||"00000";
  const name=$("pName").value.trim()||"—";
  const price=Number($("pPrice").value||0);

  $("pvName").textContent=name;
  $("pvPrice").textContent=money(price);

  drawBarcodeToSVG($("pvBarcode"), code);
}

// ---------- Products ----------
async function saveProduct(){
  const code=$("pCode").value.trim();
  const name=$("pName").value.trim();
  const price=Number($("pPrice").value);

  if(!validateCode5(code)) return alert("SKU inválido.");
  if(!name) return alert("Nombre requerido.");
  if(isNaN(price)||price<0) return alert("Precio inválido.");

  const p={code,name,price:Number(price.toFixed(2)),nameKey:norm(name),updatedAt:Date.now()};
  await idbPut("products",p);

  await refreshPicker();
  $("pCode").value=await nextCode();
  $("pName").value="";
  $("pPrice").value="";
  renderPreview();
  toast("Guardado");
}

async function refreshPicker(){
  const q=norm($("qSearch").value);
  const all=await idbAll("products");
  const list=q?all.filter(p=>norm(p.code).includes(q)||(p.nameKey||"").includes(q)):all;
  const sel=$("pick");
  sel.innerHTML="";
  if(list.length===0){
    const opt=document.createElement("option");
    opt.value="";
    opt.textContent="Sin productos";
    sel.appendChild(opt);
    return;
  }
  for(const p of list.sort((a,b)=>(a.nameKey||"").localeCompare(b.nameKey||""))){
    const opt=document.createElement("option");
    opt.value=p.code;
    opt.textContent=`${p.code} — ${p.name} — ${money(p.price)}`;
    sel.appendChild(opt);
  }
}

// ---------- Queue ----------
function loadQueue(){
  try{
    const q=JSON.parse(localStorage.getItem("mb_label_queue_v3")||"[]");
    if(Array.isArray(q)) state.queue=q;
  }catch{ state.queue=[]; }
}
function saveQueue(){ localStorage.setItem("mb_label_queue_v3",JSON.stringify(state.queue)); }
function renderQueue(){
  const tb=$("queueBody");
  tb.innerHTML="";
  if(state.queue.length===0){
    tb.innerHTML='<tr><td colspan="5"><small style="color:rgba(255,255,255,.6);font-weight:900">Cola vacía.</small></td></tr>';
    return;
  }
  state.queue.forEach((it,idx)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${it.code}</td>
      <td>${it.name}</td>
      <td>${money(it.price)}</td>
      <td>${it.qty}</td>
      <td>
        <button class="btn small secondary" data-act="edit" data-i="${idx}" type="button">Cant.</button>
        <button class="btn small danger" data-act="del" data-i="${idx}" type="button">X</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}
async function addToQueue(){
  const code=$("pick").value;
  const qty=Math.max(1,Number($("qty").value||1));
  if(!code) return alert("Seleccione un producto.");
  const p=await idbGet("products",code);
  if(!p) return alert("No encontrado.");
  state.queue.push({code:p.code,name:p.name,price:p.price,qty,updatedAt:Date.now()});
  saveQueue(); renderQueue(); toast("Agregado");
}
function clearQueue(){ state.queue=[]; saveQueue(); renderQueue(); toast("Cola limpia"); }

// ---------- Barcode (PNG para PDF) — fuerte + chaparro ----------
function barcodeDataURL(code){
  const canvas=document.createElement("canvas");

  // Alta resolución para nítido
  canvas.width=1100;
  canvas.height=260;

  JsBarcode(canvas, code, {
    format: "CODE128",
    displayValue: false,
    margin: 0,
    height: 160,     // más chaparro
    width: 9,        // MÁS fuerte (barras gruesas)
    background: "#ffffff",
    lineColor: "#000000"
  });

  return canvas.toDataURL("image/png",1.0);
}

// ---------- PDF (centrado arriba/abajo) ----------
async function openPDF(){
  if(state.queue.length===0) return alert("Cola vacía.");

  let w = Number($("lblW")?.value || 50);
  let h = Number($("lblH")?.value || 25);
  if(!isFinite(w) || w < 20) w = 50;
  if(!isFinite(h) || h < 20) h = 25;

  let ori = $("lblOri")?.value || "landscape";
  if(ori === "AUTO"){
    ori = (w >= h) ? "landscape" : "portrait";
  }

  const pageW = w, pageH = h;

  const labels=[];
  for(const it of state.queue){
    for(let i=0;i<it.qty;i++) labels.push(it);
  }

  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation: ori, unit:"mm", format:[pageW,pageH], compress:true});

  // Layout centrado para 50x25 (y funciona bien en tamaños similares)
  const m = 1.4;        // margen general
  const quiet = 1.6;    // quiet zone dentro del cuadro

  const headerH = 6.2;  // espacio para nombre+precio
  const bh = 13.5;      // altura caja código (chaparro)
  const bw = pageW - (m * 2);

  const contentH = headerH + bh;
  const topStart = (pageH - contentH) / 2;

  const nameY  = topStart + 3.2;
  const priceY = topStart + 6.0;
  const barcodeTop = topStart + headerH;

  function safeText(s){ return String(s||"").replace(/\s+/g," ").trim(); }
  function fitOneLine(doc, text, maxWidth, startSize=7.8, minSize=6.3){
    let s=startSize;
    doc.setFontSize(s);
    while(s>minSize && doc.getTextWidth(text)>maxWidth){ s-=0.2; doc.setFontSize(s); }
    if(doc.getTextWidth(text)<=maxWidth) return {size:s, text};
    doc.setFontSize(minSize);
    const ell="…";
    let lo=0, hi=text.length;
    while(lo<hi){
      const mid=Math.ceil((lo+hi)/2);
      const t=text.slice(0,mid)+ell;
      if(doc.getTextWidth(t)<=maxWidth) lo=mid;
      else hi=mid-1;
    }
    return {size:minSize, text:text.slice(0,lo)+ell};
  }

  for(let i=0;i<labels.length;i++){
    if(i>0) doc.addPage([pageW,pageH], ori);

    const it=labels[i];
    const name=safeText(it.name);
    const priceStr=money(it.price);

    // Fondo blanco
    doc.setFillColor(255,255,255);
    doc.rect(0,0,pageW,pageH,"F");

    // Texto centrado
    doc.setTextColor(0,0,0);
    doc.setFont("helvetica","bold");

    const fitted = fitOneLine(doc, name, pageW - (m*2), 7.8, 6.3);
    doc.setFontSize(fitted.size);
    doc.text(fitted.text || "—", pageW/2, nameY, { align:"center" });

    doc.setFontSize(7.6);
    doc.text(priceStr, pageW/2, priceY, { align:"center" });

    // Caja barcode centrada
    const bx = (pageW - bw) / 2;
    const by = barcodeTop;

    doc.setDrawColor(0,0,0);
    doc.setLineWidth(0.25);
    doc.setFillColor(255,255,255);
    doc.roundedRect(bx, by, bw, bh, 1.6, 1.6, "FD");

    // Barcode grande dentro
    const img=barcodeDataURL(it.code);
    doc.addImage(img, "PNG", bx + quiet, by + quiet, bw - (quiet*2), bh - (quiet*2));
  }

  const blobUrl=doc.output("bloburl");
  window.open(blobUrl,"_blank");
  toast("PDF listo");
}

// ---------- Backup ----------
async function exportJSON(){
  const products=await idbAll("products");
  const meta=await idbAll("meta");
  const data={exportedAt:new Date().toISOString(),products,meta,queue:state.queue};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="marckbusiness_generador_backup.json";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),1000);
}
async function importExcelFile(file){
  const data=new Uint8Array(await file.arrayBuffer());
  const wb=XLSX.read(data,{type:"array"});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const rows=XLSX.utils.sheet_to_json(ws,{defval:""});
  let ok=0, bad=0;

  for(const r of rows){
    const sku=String(r.SKU ?? r.sku ?? r.CODIGO ?? r.codigo ?? r.Código ?? r.codigo_barras ?? r.CODBARRAS ?? "").trim();
    const name=String(r.NOMBRE ?? r.nombre ?? r.PRODUCTO ?? r.producto ?? "").trim();
    const priceRaw=r.PRECIO ?? r.precio ?? r.PRICE ?? r.price ?? "";
    const price=Number(String(priceRaw).replace(/[^0-9.]/g,""));
    if(!validateCode5(sku)||!name||isNaN(price)){bad++;continue;}
    await idbPut("products",{code:sku,name,price:Number(price.toFixed(2)),nameKey:norm(name),updatedAt:Date.now()});
    ok++;
  }
  await refreshPicker();
  renderPreview();
  toast("Excel importado");
  if(bad>0) alert("Importados: "+ok+" | Saltados: "+bad+" (revisa columnas SKU/NOMBRE/PRECIO).");
}

// ---------- Events ----------
function wire(){
  // LOGIN
  $("btnLogin").addEventListener("click", doLogin);
  $("btnLoginClear").addEventListener("click", ()=>{ $("loginCode").value=""; $("loginCode").focus(); });
  $("loginCode").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); doLogin(); } });
  $("btnLogout").addEventListener("click", doLogout);

  // Preview inputs
  ["pCode","pName","pPrice"].forEach(id=>$(id).addEventListener("input",renderPreview));

  // Products
  $("btnSave").addEventListener("click",saveProduct);
  $("btnClearForm").addEventListener("click",async()=>{
    $("pCode").value=await nextCode();
    $("pName").value="";
    $("pPrice").value="";
    renderPreview();
  });
  $("btnNext").addEventListener("click",async()=>{
    $("pCode").value=await nextCode();
    $("pCode").focus();
    $("pCode").select();
    renderPreview();
  });

  // Picker/search
  $("qSearch").addEventListener("input",refreshPicker);
  $("btnRefresh").addEventListener("click",refreshPicker);

  // Queue
  $("btnAddToQueue").addEventListener("click",addToQueue);
  $("btnClearQueue").addEventListener("click",clearQueue);
  $("btnPDF").addEventListener("click",openPDF);

  $("queueBody").addEventListener("click",(e)=>{
    const b=e.target.closest("button[data-act]");
    if(!b) return;
    const i=Number(b.dataset.i);
    if(b.dataset.act==="del"){
      state.queue.splice(i,1);
      saveQueue();
      renderQueue();
    }
    if(b.dataset.act==="edit"){
      const v=prompt("Nueva cantidad:",state.queue[i].qty);
      if(v===null) return;
      state.queue[i].qty=Math.max(1,Number(v||1));
      saveQueue();
      renderQueue();
    }
  });

  // Import/export
  $("btnExcel").addEventListener("click",()=>$("excelFile").click());
  $("excelFile").addEventListener("change",async(e)=>{
    const file=e.target.files?.[0];
    if(!file) return;
    try{ await importExcelFile(file); }
    catch(err){ alert("Error importando Excel."); }
    e.target.value="";
  });
  $("btnExport").addEventListener("click",exportJSON);

  // Wipe
  $("btnWipe").addEventListener("click",async()=>{
    if(confirm("¿Borrar todo?")){
      await idbClear();
      state.queue=[];
      saveQueue();
      await refreshPicker();
      renderQueue();
      $("pCode").value=await nextCode();
      $("pName").value="";
      $("pPrice").value="";
      renderPreview();
    }
  });

  // Ctrl+Enter para guardar
  window.addEventListener("keydown",(e)=>{
    if(e.key==="Enter"&&e.ctrlKey){
      e.preventDefault();
      saveProduct();
    }
  });
}

// ---------- Init ----------
(async function init(){
  if(isLoggedIn()) showApp();
  else showLogin();

  db=await openDB();

  loadQueue();
  renderQueue();

  const meta=await idbGet("meta","next");
  $("pCode").value=meta?.value?pad5(meta.value):pad5(1);

  await refreshPicker();
  renderPreview();
  wire();
})();
</script>
</body>
</html>
